name: ðŸ“¦ Build Openwrt_x86-64 24.10.X

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: true
        default: "24.10.5"
        type: choice
        options:
          - '24.10.0'
          - '24.10.1'
          - '24.10.2'
          - '24.10.3'
          - '24.10.4' 
          - '24.10.5'           
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IP'
        required: true
        default: '192.168.5.1'

env:
  VERSION: ${{ inputs.luci_version }}

jobs:
  build:
    runs-on: ubuntu-22.04
    # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œè§£å†³ 403 æŠ¥é”™
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x x86/build_config.sh
        chmod +x shell/*.sh

    - name: âš™ï¸ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip tree

    - name: âš™ï¸ è®¾ç½®IPã€ç½‘å…³å’Œç‰ˆæœ¬å·
      run: |
        CONFIG_PATH="./files/uci-defaults/99-custom.sh"
        sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "$CONFIG_PATH"
        [ -f "./files/etc/banner" ] && sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "./files/etc/banner"
        sed -i "s/__IPADDR__/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
        sed -i "s/VERXXXX/${{ env.VERSION }}/g" "$CONFIG_PATH"

    - name: â¬ ä¸‹è½½ ImageBuilder
      run: |
        BUILD_VER="${{ env.VERSION }}"
        URL="https://downloads.openwrt.org/releases/${BUILD_VER}/targets/x86/64/openwrt-imagebuilder-${BUILD_VER}-x86-64.Linux-x86_64.tar.zst"
        curl -Lf -o imagebuilder.tar.zst "$URL"
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    - name: â¬ å¤åˆ¶å¿…å¤‡æ–‡ä»¶
      run: |
        cp x86/build_config.sh imagebuilder/
        cp x86/Makefile imagebuilder/
        cp x86/repositories.conf imagebuilder/
        cp shell/prepare-packages.sh imagebuilder/
        cp shell/custom-packages.sh imagebuilder/
        mkdir -p imagebuilder/files/etc/uci-defaults
        cp files/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        mkdir -p imagebuilder/files/etc/opkg
        cp -r files/customfeeds/* imagebuilder/files/etc/opkg/ 2>/dev/null || true
        # éªŒè¯ä¿¡æ¯
        ls -l imagebuilder/files/etc/opkg/customfeeds.conf && echo "å·²æ‹·è´ customfeeds.conf"

    - name: âš™ï¸ åŠ¨æ€èŽ·å– Kmod å“ˆå¸Œå¹¶æ›´æ–°é…ç½®
      run: |
        BUILD_VER="${{ env.VERSION }}"
        BASE_URL="https://downloads.openwrt.org/releases/${BUILD_VER}/targets/x86/64/kmods/"
        
        echo "æ­£åœ¨ä»Ž $BASE_URL èŽ·å–æœ€æ–°çš„å†…æ ¸å“ˆå¸Œ..."
        # æŠ“å–åŒ…å«å“ˆå¸Œå€¼çš„æ–‡ä»¶å¤¹åç§° (ä¾‹å¦‚ 6.6.110-1-xxx...)
        KMOD_DIR=$(curl -sL $BASE_URL | grep -oE "[0-9.-]+-[a-f0-9]{32}" | head -n 1)
        
        if [ -n "$KMOD_DIR" ]; then
          FULL_KMOD_URL="${BASE_URL}${KMOD_DIR}"
          echo "âœ… æˆåŠŸåŒ¹é… kmods è·¯å¾„: $FULL_KMOD_URL"
          
          # 1. æ›¿æ¢ç‰ˆæœ¬å ä½ç¬¦
          sed -i "s|VERSION_PLACEHOLDER|${BUILD_VER}|g" imagebuilder/repositories.conf
          # 2. æ›¿æ¢ Kmod å®Œæ•´è·¯å¾„
          sed -i "s|https://.*/kmods/KMOD_PLACEHOLDER|$FULL_KMOD_URL|g" imagebuilder/repositories.conf
        else
          echo "âŒ æ— æ³•èŽ·å– Kmod å“ˆå¸Œï¼Œè¯·æ£€æŸ¥å®˜æ–¹æºæ˜¯å¦å­˜åœ¨è¯¥ç‰ˆæœ¬: $BASE_URL"
          exit 1
        fi
        
        echo "--- æ£€æŸ¥æ›´æ–°åŽçš„ repositories.conf ---"
        cat imagebuilder/repositories.conf | grep "https"

    - name: ðŸ§± æž„å»ºOpenWrtå›ºä»¶
      working-directory: ./imagebuilder
      run: |
        bash ./build_config.sh

    - name: ðŸ“œ ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > ${{ github.workspace }}/router-info.md <<EOF
        ## ðŸ“¡ è·¯ç”±å™¨åŽå°ä¿¡æ¯
        ðŸ“Œ ç‰ˆæœ¬ï¼š OpenWrt-x86-64-${{ env.VERSION }}
        ðŸŒ åˆå§‹IPï¼š ${{ inputs.ipaddr }}
        EOF

    - name: ðŸš€ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: OpenWrt-${{ env.VERSION }}-x86-64-RELEASE
        body_path: ${{ github.workspace }}/router-info.md
        files: |
          imagebuilder/bin/targets/x86/64/*squashfs-combined-efi.img.gz
          imagebuilder/bin/targets/x86/64/sha256sums
        token: ${{ secrets.GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
